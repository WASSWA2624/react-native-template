{"version":3,"names":["handleError","apiClient","getQueue","removeFromQueue","getIsOnline","subscribe","unsubscribeSync","cov_21oxchbdcf","s","processQueue","_ref","_asyncToGenerator","f","b","queue","length","item","id","error","scope","op","apply","arguments","startSync","isOnline","stopSync","__unsafeResetForTests"],"sources":["sync.manager.js"],"sourcesContent":["/**\r\n * Sync Manager\r\n * Orchestrates queue execution\r\n * File: sync.manager.js\r\n */\r\nimport { handleError } from '@errors';\r\nimport { apiClient } from '@services/api';\r\nimport { getQueue, removeFromQueue } from '@offline/queue';\r\nimport { getIsOnline, subscribe } from '@offline/network.listener';\r\n\r\nlet unsubscribeSync = null;\r\n\r\nexport const processQueue = async () => {\r\n  if (!getIsOnline()) return;\r\n\r\n  const queue = await getQueue();\r\n  if (queue.length === 0) return;\r\n\r\n  for (const item of queue) {\r\n    try {\r\n      await apiClient(item);\r\n      await removeFromQueue(item.id);\r\n    } catch (error) {\r\n      handleError(error, {\r\n        scope: 'offline.sync.manager',\r\n        op: 'processQueueItem',\r\n        id: item?.id,\r\n      });\r\n      // Keep in queue for retry\r\n    }\r\n  }\r\n};\r\n\r\n/**\r\n * Start syncing on network reconnect.\r\n * Idempotent: repeated calls return the same unsubscribe function.\r\n */\r\nexport const startSync = () => {\r\n  if (unsubscribeSync) return unsubscribeSync;\r\n\r\n  unsubscribeSync = subscribe((isOnline) => {\r\n    if (isOnline) {\r\n      // Fire-and-forget; offline sync must not block UI thread.\r\n      processQueue();\r\n    }\r\n  });\r\n\r\n  return unsubscribeSync;\r\n};\r\n\r\nexport const stopSync = () => {\r\n  if (!unsubscribeSync) return;\r\n  try {\r\n    unsubscribeSync();\r\n  } finally {\r\n    unsubscribeSync = null;\r\n  }\r\n};\r\n\r\n/**\r\n * Testing-only reset helper to avoid state leaking across unit tests.\r\n * @private\r\n */\r\nexport const __unsafeResetForTests = () => {\r\n  stopSync();\r\n};\r\n\r\nexport default {\r\n  processQueue,\r\n  startSync,\r\n  stopSync,\r\n};\r\n\r\n"],"mappings":"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","ignoreList":[]}