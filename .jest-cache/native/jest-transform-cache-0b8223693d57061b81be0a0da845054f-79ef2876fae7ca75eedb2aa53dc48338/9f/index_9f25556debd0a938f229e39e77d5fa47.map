{"version":3,"names":["_endpoints","require","cachedToken","tokenFetchPromise","CSRF_HEADER","exports","fetchCsrfToken","_ref","_asyncToGenerator2","default","_result$data","url","endpoints","AUTH","CSRF_TOKEN","console","log","response","fetch","method","credentials","headers","ok","Error","status","statusText","result","json","token","data","JSON","stringify","error","apply","arguments","getCsrfToken","_ref2","finally","clearCsrfToken","getCsrfHeaders","_ref3","_defineProperty2","message"],"sources":["index.js"],"sourcesContent":["/**\r\n * CSRF Token Service\r\n * Manages CSRF token fetching and caching\r\n * File: index.js\r\n */\r\nimport { endpoints } from '@config/endpoints';\r\n\r\nlet cachedToken = null;\r\nlet tokenFetchPromise = null;\r\n\r\nconst CSRF_HEADER = 'x-csrf-token';\r\n\r\n/**\r\n * Fetch CSRF token from server\r\n * @returns {Promise<string>} CSRF token\r\n */\r\nconst fetchCsrfToken = async () => {\r\n  try {\r\n    const url = endpoints.AUTH.CSRF_TOKEN;\r\n    console.log('[CSRF] Fetching token from:', url);\r\n    \r\n    const response = await fetch(url, {\r\n      method: 'GET',\r\n      credentials: 'include', // Include cookies for session\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n      },\r\n    });\r\n\r\n    if (!response.ok) {\r\n      throw new Error(`Failed to fetch CSRF token: ${response.status} ${response.statusText}`);\r\n    }\r\n\r\n    const result = await response.json();\r\n    const token = result?.data?.token;\r\n    \r\n    if (!token) {\r\n      throw new Error(`CSRF token not in response: ${JSON.stringify(result)}`);\r\n    }\r\n\r\n    cachedToken = token;\r\n    console.log('[CSRF] Token fetched successfully');\r\n    return token;\r\n  } catch (error) {\r\n    console.error('[CSRF] Error fetching token:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n/**\r\n * Get CSRF token, fetching if necessary\r\n * Uses caching and deduplication to avoid multiple requests\r\n * @returns {Promise<string>} CSRF token\r\n */\r\nconst getCsrfToken = async () => {\r\n  // Return cached token if available\r\n  if (cachedToken) {\r\n    return cachedToken;\r\n  }\r\n\r\n  // Return existing fetch promise to deduplicate requests\r\n  if (tokenFetchPromise) {\r\n    return tokenFetchPromise;\r\n  }\r\n\r\n  // Start new fetch and cache the promise\r\n  tokenFetchPromise = fetchCsrfToken()\r\n    .finally(() => {\r\n      tokenFetchPromise = null; // Clear promise after resolution\r\n    });\r\n\r\n  return tokenFetchPromise;\r\n};\r\n\r\n/**\r\n * Clear cached CSRF token\r\n * Call this after logout or session expiry\r\n */\r\nconst clearCsrfToken = () => {\r\n  cachedToken = null;\r\n  tokenFetchPromise = null;\r\n};\r\n\r\n/**\r\n * Get CSRF headers for API requests\r\n * @returns {Promise<Object>} Headers object with CSRF token\r\n */\r\nconst getCsrfHeaders = async () => {\r\n  try {\r\n    const token = await getCsrfToken();\r\n    console.log('[CSRF] Adding token to request headers');\r\n    return {\r\n      [CSRF_HEADER]: token,\r\n    };\r\n  } catch (error) {\r\n    console.error('[CSRF] Failed to get CSRF token for headers:', error.message);\r\n    // Don't silently fail - let the caller know\r\n    throw error;\r\n  }\r\n};\r\n\r\nexport {\r\n  getCsrfToken,\r\n  getCsrfHeaders,\r\n  clearCsrfToken,\r\n  CSRF_HEADER,\r\n};\r\n"],"mappings":"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","ignoreList":[]}