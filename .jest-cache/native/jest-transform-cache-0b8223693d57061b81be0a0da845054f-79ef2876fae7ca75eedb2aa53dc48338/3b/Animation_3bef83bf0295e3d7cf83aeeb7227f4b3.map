{"version":3,"names":["_NativeAnimatedHelper","_interopRequireDefault","require","ReactNativeFeatureFlags","_interopRequireWildcard","_AnimatedProps","startNativeAnimationNextId","_nativeID","_classPrivateFieldLooseKey2","default","_onEnd","_useNativeDriver","Animation","exports","config","_config$isInteraction","_config$iterations","_classCallCheck2","Object","defineProperty","writable","value","_classPrivateFieldLooseBase2","NativeAnimatedHelper","shouldUseNativeDriver","__active","__isInteraction","isInteraction","__isLooping","isLooping","__iterations","iterations","__DEV__","__debugID","debugID","_createClass2","key","start","fromValue","onUpdate","onEnd","previousAnimation","animatedValue","__isNative","Error","stop","nativeID","identifier","API","setWaitingForIdentifier","stopAnimation","unsetWaitingForIdentifier","__getNativeAnimationConfig","__findAnimatedPropsNodes","node","result","AnimatedProps","push","child","__getChildren","apply","_toConsumableArray2","__startAnimationIfNative","_this","startNativeAnimationWaitId","__makeNative","platformConfig","generateNewAnimationId","startAnimatingNode","__getNativeTag","__notifyAnimationEnd","offset","__onAnimatedValueUpdateReceived","cxxNativeAnimatedEnabled","cxxNativeAnimatedRemoveJsSync","forEach","update","e","callback","__getDebugID","undefined"],"sources":["Animation.js"],"sourcesContent":["/**\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow strict-local\n * @format\n */\n\nimport type {PlatformConfig} from '../AnimatedPlatformConfig';\nimport type AnimatedNode from '../nodes/AnimatedNode';\nimport type AnimatedValue from '../nodes/AnimatedValue';\n\nimport NativeAnimatedHelper from '../../../src/private/animated/NativeAnimatedHelper';\nimport * as ReactNativeFeatureFlags from '../../../src/private/featureflags/ReactNativeFeatureFlags';\nimport AnimatedProps from '../nodes/AnimatedProps';\n\nexport type EndResult = {\n  finished: boolean,\n  value?: number,\n  offset?: number,\n  ...\n};\nexport type EndCallback = (result: EndResult) => void;\n\nexport type AnimationConfig = $ReadOnly<{\n  isInteraction?: boolean,\n  useNativeDriver: boolean,\n  platformConfig?: PlatformConfig,\n  onComplete?: ?EndCallback,\n  iterations?: number,\n  isLooping?: boolean,\n  debugID?: ?string,\n  ...\n}>;\n\nlet startNativeAnimationNextId = 1;\n\n// Important note: start() and stop() will only be called at most once.\n// Once an animation has been stopped or finished its course, it will\n// not be reused.\nexport default class Animation {\n  #nativeID: ?number;\n  #onEnd: ?EndCallback;\n  #useNativeDriver: boolean;\n\n  __active: boolean;\n  __isInteraction: boolean;\n  __isLooping: ?boolean;\n  __iterations: number;\n  __debugID: ?string;\n\n  constructor(config: AnimationConfig) {\n    this.#useNativeDriver = NativeAnimatedHelper.shouldUseNativeDriver(config);\n\n    this.__active = false;\n    this.__isInteraction = config.isInteraction ?? !this.#useNativeDriver;\n    this.__isLooping = config.isLooping;\n    this.__iterations = config.iterations ?? 1;\n    if (__DEV__) {\n      this.__debugID = config.debugID;\n    }\n  }\n\n  start(\n    fromValue: number,\n    onUpdate: (value: number) => void,\n    onEnd: ?EndCallback,\n    previousAnimation: ?Animation,\n    animatedValue: AnimatedValue,\n  ): void {\n    if (!this.#useNativeDriver && animatedValue.__isNative === true) {\n      throw new Error(\n        'Attempting to run JS driven animation on animated node ' +\n          'that has been moved to \"native\" earlier by starting an ' +\n          'animation with `useNativeDriver: true`',\n      );\n    }\n\n    this.#onEnd = onEnd;\n    this.__active = true;\n  }\n\n  stop(): void {\n    if (this.#nativeID != null) {\n      const nativeID = this.#nativeID;\n      const identifier = `${nativeID}:stopAnimation`;\n      try {\n        // This is only required when singleOpBatching is used, as otherwise\n        // we flush calls immediately when there's no pending queue.\n        NativeAnimatedHelper.API.setWaitingForIdentifier(identifier);\n        NativeAnimatedHelper.API.stopAnimation(nativeID);\n      } finally {\n        NativeAnimatedHelper.API.unsetWaitingForIdentifier(identifier);\n      }\n    }\n    this.__active = false;\n  }\n\n  __getNativeAnimationConfig(): $ReadOnly<{\n    platformConfig: ?PlatformConfig,\n    ...\n  }> {\n    // Subclasses that have corresponding animation implementation done in native\n    // should override this method\n    throw new Error('This animation type cannot be offloaded to native');\n  }\n\n  __findAnimatedPropsNodes(node: AnimatedNode): Array<AnimatedProps> {\n    const result = [];\n\n    if (node instanceof AnimatedProps) {\n      result.push(node);\n      return result;\n    }\n\n    for (const child of node.__getChildren()) {\n      result.push(...this.__findAnimatedPropsNodes(child));\n    }\n\n    return result;\n  }\n\n  __startAnimationIfNative(animatedValue: AnimatedValue): boolean {\n    if (!this.#useNativeDriver) {\n      return false;\n    }\n\n    const startNativeAnimationWaitId = `${startNativeAnimationNextId}:startAnimation`;\n    startNativeAnimationNextId += 1;\n    NativeAnimatedHelper.API.setWaitingForIdentifier(\n      startNativeAnimationWaitId,\n    );\n    try {\n      const config = this.__getNativeAnimationConfig();\n      animatedValue.__makeNative(config.platformConfig);\n      this.#nativeID = NativeAnimatedHelper.generateNewAnimationId();\n      NativeAnimatedHelper.API.startAnimatingNode(\n        this.#nativeID,\n        animatedValue.__getNativeTag(),\n        config,\n        result => {\n          this.__notifyAnimationEnd(result);\n\n          // When using natively driven animations, once the animation completes,\n          // we need to ensure that the JS side nodes are synced with the updated\n          // values.\n          const {value, offset} = result;\n          if (value != null) {\n            animatedValue.__onAnimatedValueUpdateReceived(value, offset);\n\n            if (\n              !(\n                ReactNativeFeatureFlags.cxxNativeAnimatedEnabled() &&\n                ReactNativeFeatureFlags.cxxNativeAnimatedRemoveJsSync()\n              )\n            ) {\n              if (this.__isLooping === true) {\n                return;\n              }\n            }\n\n            // Once the JS side node is synced with the updated values, trigger an\n            // update on the AnimatedProps nodes to call any registered callbacks.\n            this.__findAnimatedPropsNodes(animatedValue).forEach(node =>\n              node.update(),\n            );\n          }\n        },\n      );\n\n      return true;\n    } catch (e) {\n      throw e;\n    } finally {\n      NativeAnimatedHelper.API.unsetWaitingForIdentifier(\n        startNativeAnimationWaitId,\n      );\n    }\n  }\n\n  /**\n   * Notify the completion callback that the animation has ended. The completion\n   * callback will never be called more than once.\n   */\n  __notifyAnimationEnd(result: EndResult): void {\n    const callback = this.#onEnd;\n    if (callback != null) {\n      this.#onEnd = null;\n      callback(result);\n    }\n  }\n\n  __getDebugID(): ?string {\n    if (__DEV__) {\n      return this.__debugID;\n    }\n    return undefined;\n  }\n}\n"],"mappings":"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","ignoreList":[]}