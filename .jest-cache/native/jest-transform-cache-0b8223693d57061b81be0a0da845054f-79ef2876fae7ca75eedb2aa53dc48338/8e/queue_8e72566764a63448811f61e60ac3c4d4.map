{"version":3,"names":["handleError","encryption","async","asyncStorage","QUEUE_KEY","cov_3yryk4iw5","s","reportQueueError","error","context","f","Object","assign","scope","asSafeArray","value","Array","isArray","b","persistEncryptedQueue","_ref","_asyncToGenerator","queue","json","JSON","stringify","encrypted","encrypt","setItem","op","key","_x","apply","arguments","getQueue","_ref2","stored","getItem","migrated","removeItem","decrypt","parsed","parse","addToQueue","_ref3","request","now","Date","push","id","String","timestamp","_x2","removeFromQueue","_ref4","requestId","filtered","filter","item","_x3","clearQueue","_ref5"],"sources":["queue.js"],"sourcesContent":["/**\r\n * Offline Queue\r\n * Stores failed/deferred requests\r\n * File: queue.js\r\n */\r\nimport { handleError } from '@errors';\r\nimport { encryption } from '@security';\r\nimport { async as asyncStorage } from '@services/storage';\r\n\r\nconst QUEUE_KEY = 'offline_queue';\r\n\r\nconst reportQueueError = (error, context) => {\r\n  handleError(error, {\r\n    scope: 'offline.queue',\r\n    ...context,\r\n  });\r\n};\r\n\r\nconst asSafeArray = (value) => {\r\n  return Array.isArray(value) ? value : [];\r\n};\r\n\r\nconst persistEncryptedQueue = async (queue) => {\r\n  try {\r\n    const json = JSON.stringify(asSafeArray(queue));\r\n    const encrypted = await encryption.encrypt(json);\r\n    return await asyncStorage.setItem(QUEUE_KEY, encrypted);\r\n  } catch (error) {\r\n    reportQueueError(error, { op: 'persistEncryptedQueue', key: QUEUE_KEY });\r\n    return false;\r\n  }\r\n};\r\n\r\n/**\r\n * Read queue from storage, decrypting if available.\r\n * Security-first: queue is never persisted unencrypted.\r\n */\r\nexport const getQueue = async () => {\r\n  const stored = await asyncStorage.getItem(QUEUE_KEY);\r\n  if (!stored) return [];\r\n\r\n  // Legacy (non-compliant) format: array stored unencrypted.\r\n  // We never keep this around â€” migrate to encrypted if possible; otherwise clear it.\r\n  if (Array.isArray(stored)) {\r\n    try {\r\n      const migrated = await persistEncryptedQueue(stored);\r\n      if (!migrated) {\r\n        await asyncStorage.removeItem(QUEUE_KEY);\r\n        return [];\r\n      }\r\n      return stored;\r\n    } catch (error) {\r\n      reportQueueError(error, { op: 'migrateLegacyQueue', key: QUEUE_KEY });\r\n      await asyncStorage.removeItem(QUEUE_KEY);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  if (typeof stored !== 'string') {\r\n    await asyncStorage.removeItem(QUEUE_KEY);\r\n    return [];\r\n  }\r\n\r\n  try {\r\n    const json = await encryption.decrypt(stored);\r\n    const parsed = JSON.parse(json);\r\n    return asSafeArray(parsed);\r\n  } catch (error) {\r\n    reportQueueError(error, { op: 'decryptQueue', key: QUEUE_KEY });\r\n    await asyncStorage.removeItem(QUEUE_KEY);\r\n    return [];\r\n  }\r\n};\r\n\r\nexport const addToQueue = async (request) => {\r\n  const queue = await getQueue();\r\n  const now = Date.now();\r\n  queue.push({\r\n    ...request,\r\n    id: String(now),\r\n    timestamp: now,\r\n  });\r\n  return await persistEncryptedQueue(queue);\r\n};\r\n\r\nexport const removeFromQueue = async (requestId) => {\r\n  const queue = await getQueue();\r\n  const filtered = queue.filter((item) => item?.id !== requestId);\r\n  return await persistEncryptedQueue(filtered);\r\n};\r\n\r\nexport const clearQueue = async () => {\r\n  // Removing the key is safe and avoids persisting even an empty queue when crypto is unavailable.\r\n  return await asyncStorage.removeItem(QUEUE_KEY);\r\n};\r\n\r\nexport default {\r\n  getQueue,\r\n  addToQueue,\r\n  removeFromQueue,\r\n  clearQueue,\r\n};\r\n\r\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAKA,SAASA,WAAW;AACpB,SAASC,UAAU;AACnB,SAASC,KAAK,IAAIC,YAAY;AAE9B,IAAMC,SAAS,IAAAC,aAAA,GAAAC,CAAA,OAAG,eAAe;AAACD,aAAA,GAAAC,CAAA;AAElC,IAAMC,gBAAgB,GAAG,SAAnBA,gBAAgBA,CAAIC,KAAK,EAAEC,OAAO,EAAK;EAAAJ,aAAA,GAAAK,CAAA;EAAAL,aAAA,GAAAC,CAAA;EAC3CN,WAAW,CAACQ,KAAK,EAAAG,MAAA,CAAAC,MAAA;IACfC,KAAK,EAAE;EAAe,GACnBJ,OAAO,CACX,CAAC;AACJ,CAAC;AAACJ,aAAA,GAAAC,CAAA;AAEF,IAAMQ,WAAW,GAAG,SAAdA,WAAWA,CAAIC,KAAK,EAAK;EAAAV,aAAA,GAAAK,CAAA;EAAAL,aAAA,GAAAC,CAAA;EAC7B,OAAOU,KAAK,CAACC,OAAO,CAACF,KAAK,CAAC,IAAAV,aAAA,GAAAa,CAAA,UAAGH,KAAK,KAAAV,aAAA,GAAAa,CAAA,UAAG,EAAE;AAC1C,CAAC;AAACb,aAAA,GAAAC,CAAA;AAEF,IAAMa,qBAAqB;EAAA,IAAAC,IAAA,GAAAC,iBAAA,CAAG,WAAOC,KAAK,EAAK;IAAAjB,aAAA,GAAAK,CAAA;IAAAL,aAAA,GAAAC,CAAA;IAC7C,IAAI;MACF,IAAMiB,IAAI,IAAAlB,aAAA,GAAAC,CAAA,OAAGkB,IAAI,CAACC,SAAS,CAACX,WAAW,CAACQ,KAAK,CAAC,CAAC;MAC/C,IAAMI,SAAS,IAAArB,aAAA,GAAAC,CAAA,aAASL,UAAU,CAAC0B,OAAO,CAACJ,IAAI,CAAC;MAAClB,aAAA,GAAAC,CAAA;MACjD,aAAaH,YAAY,CAACyB,OAAO,CAACxB,SAAS,EAAEsB,SAAS,CAAC;IACzD,CAAC,CAAC,OAAOlB,KAAK,EAAE;MAAAH,aAAA,GAAAC,CAAA;MACdC,gBAAgB,CAACC,KAAK,EAAE;QAAEqB,EAAE,EAAE,uBAAuB;QAAEC,GAAG,EAAE1B;MAAU,CAAC,CAAC;MAACC,aAAA,GAAAC,CAAA;MACzE,OAAO,KAAK;IACd;EACF,CAAC;EAAA,gBATKa,qBAAqBA,CAAAY,EAAA;IAAA,OAAAX,IAAA,CAAAY,KAAA,OAAAC,SAAA;EAAA;AAAA,GAS1B;AAAC5B,aAAA,GAAAC,CAAA;AAMF,OAAO,IAAM4B,QAAQ;EAAA,IAAAC,KAAA,GAAAd,iBAAA,CAAG,aAAY;IAAAhB,aAAA,GAAAK,CAAA;IAClC,IAAM0B,MAAM,IAAA/B,aAAA,GAAAC,CAAA,cAASH,YAAY,CAACkC,OAAO,CAACjC,SAAS,CAAC;IAACC,aAAA,GAAAC,CAAA;IACrD,IAAI,CAAC8B,MAAM,EAAE;MAAA/B,aAAA,GAAAa,CAAA;MAAAb,aAAA,GAAAC,CAAA;MAAA,OAAO,EAAE;IAAA,CAAC;MAAAD,aAAA,GAAAa,CAAA;IAAA;IAAAb,aAAA,GAAAC,CAAA;IAIvB,IAAIU,KAAK,CAACC,OAAO,CAACmB,MAAM,CAAC,EAAE;MAAA/B,aAAA,GAAAa,CAAA;MAAAb,aAAA,GAAAC,CAAA;MACzB,IAAI;QACF,IAAMgC,QAAQ,IAAAjC,aAAA,GAAAC,CAAA,cAASa,qBAAqB,CAACiB,MAAM,CAAC;QAAC/B,aAAA,GAAAC,CAAA;QACrD,IAAI,CAACgC,QAAQ,EAAE;UAAAjC,aAAA,GAAAa,CAAA;UAAAb,aAAA,GAAAC,CAAA;UACb,MAAMH,YAAY,CAACoC,UAAU,CAACnC,SAAS,CAAC;UAACC,aAAA,GAAAC,CAAA;UACzC,OAAO,EAAE;QACX,CAAC;UAAAD,aAAA,GAAAa,CAAA;QAAA;QAAAb,aAAA,GAAAC,CAAA;QACD,OAAO8B,MAAM;MACf,CAAC,CAAC,OAAO5B,KAAK,EAAE;QAAAH,aAAA,GAAAC,CAAA;QACdC,gBAAgB,CAACC,KAAK,EAAE;UAAEqB,EAAE,EAAE,oBAAoB;UAAEC,GAAG,EAAE1B;QAAU,CAAC,CAAC;QAACC,aAAA,GAAAC,CAAA;QACtE,MAAMH,YAAY,CAACoC,UAAU,CAACnC,SAAS,CAAC;QAACC,aAAA,GAAAC,CAAA;QACzC,OAAO,EAAE;MACX;IACF,CAAC;MAAAD,aAAA,GAAAa,CAAA;IAAA;IAAAb,aAAA,GAAAC,CAAA;IAED,IAAI,OAAO8B,MAAM,KAAK,QAAQ,EAAE;MAAA/B,aAAA,GAAAa,CAAA;MAAAb,aAAA,GAAAC,CAAA;MAC9B,MAAMH,YAAY,CAACoC,UAAU,CAACnC,SAAS,CAAC;MAACC,aAAA,GAAAC,CAAA;MACzC,OAAO,EAAE;IACX,CAAC;MAAAD,aAAA,GAAAa,CAAA;IAAA;IAAAb,aAAA,GAAAC,CAAA;IAED,IAAI;MACF,IAAMiB,IAAI,IAAAlB,aAAA,GAAAC,CAAA,cAASL,UAAU,CAACuC,OAAO,CAACJ,MAAM,CAAC;MAC7C,IAAMK,MAAM,IAAApC,aAAA,GAAAC,CAAA,QAAGkB,IAAI,CAACkB,KAAK,CAACnB,IAAI,CAAC;MAAClB,aAAA,GAAAC,CAAA;MAChC,OAAOQ,WAAW,CAAC2B,MAAM,CAAC;IAC5B,CAAC,CAAC,OAAOjC,KAAK,EAAE;MAAAH,aAAA,GAAAC,CAAA;MACdC,gBAAgB,CAACC,KAAK,EAAE;QAAEqB,EAAE,EAAE,cAAc;QAAEC,GAAG,EAAE1B;MAAU,CAAC,CAAC;MAACC,aAAA,GAAAC,CAAA;MAChE,MAAMH,YAAY,CAACoC,UAAU,CAACnC,SAAS,CAAC;MAACC,aAAA,GAAAC,CAAA;MACzC,OAAO,EAAE;IACX;EACF,CAAC;EAAA,gBAnCY4B,QAAQA,CAAA;IAAA,OAAAC,KAAA,CAAAH,KAAA,OAAAC,SAAA;EAAA;AAAA,GAmCpB;AAAC5B,aAAA,GAAAC,CAAA;AAEF,OAAO,IAAMqC,UAAU;EAAA,IAAAC,KAAA,GAAAvB,iBAAA,CAAG,WAAOwB,OAAO,EAAK;IAAAxC,aAAA,GAAAK,CAAA;IAC3C,IAAMY,KAAK,IAAAjB,aAAA,GAAAC,CAAA,cAAS4B,QAAQ,CAAC,CAAC;IAC9B,IAAMY,GAAG,IAAAzC,aAAA,GAAAC,CAAA,QAAGyC,IAAI,CAACD,GAAG,CAAC,CAAC;IAACzC,aAAA,GAAAC,CAAA;IACvBgB,KAAK,CAAC0B,IAAI,CAAArC,MAAA,CAAAC,MAAA,KACLiC,OAAO;MACVI,EAAE,EAAEC,MAAM,CAACJ,GAAG,CAAC;MACfK,SAAS,EAAEL;IAAG,EACf,CAAC;IAACzC,aAAA,GAAAC,CAAA;IACH,aAAaa,qBAAqB,CAACG,KAAK,CAAC;EAC3C,CAAC;EAAA,gBATYqB,UAAUA,CAAAS,GAAA;IAAA,OAAAR,KAAA,CAAAZ,KAAA,OAAAC,SAAA;EAAA;AAAA,GAStB;AAAC5B,aAAA,GAAAC,CAAA;AAEF,OAAO,IAAM+C,eAAe;EAAA,IAAAC,KAAA,GAAAjC,iBAAA,CAAG,WAAOkC,SAAS,EAAK;IAAAlD,aAAA,GAAAK,CAAA;IAClD,IAAMY,KAAK,IAAAjB,aAAA,GAAAC,CAAA,cAAS4B,QAAQ,CAAC,CAAC;IAC9B,IAAMsB,QAAQ,IAAAnD,aAAA,GAAAC,CAAA,QAAGgB,KAAK,CAACmC,MAAM,CAAC,UAACC,IAAI,EAAK;MAAArD,aAAA,GAAAK,CAAA;MAAAL,aAAA,GAAAC,CAAA;MAAA,QAAAoD,IAAI,oBAAJA,IAAI,CAAET,EAAE,MAAKM,SAAS;IAAD,CAAC,CAAC;IAAClD,aAAA,GAAAC,CAAA;IAChE,aAAaa,qBAAqB,CAACqC,QAAQ,CAAC;EAC9C,CAAC;EAAA,gBAJYH,eAAeA,CAAAM,GAAA;IAAA,OAAAL,KAAA,CAAAtB,KAAA,OAAAC,SAAA;EAAA;AAAA,GAI3B;AAAC5B,aAAA,GAAAC,CAAA;AAEF,OAAO,IAAMsD,UAAU;EAAA,IAAAC,KAAA,GAAAxC,iBAAA,CAAG,aAAY;IAAAhB,aAAA,GAAAK,CAAA;IAAAL,aAAA,GAAAC,CAAA;IAEpC,aAAaH,YAAY,CAACoC,UAAU,CAACnC,SAAS,CAAC;EACjD,CAAC;EAAA,gBAHYwD,UAAUA,CAAA;IAAA,OAAAC,KAAA,CAAA7B,KAAA,OAAAC,SAAA;EAAA;AAAA,GAGtB;AAED,eAAe;EACbC,QAAQ,EAARA,QAAQ;EACRS,UAAU,EAAVA,UAAU;EACVU,eAAe,EAAfA,eAAe;EACfO,UAAU,EAAVA;AACF,CAAC","ignoreList":[]}