{"version":3,"names":["_errors","require","_security","_storage","QUEUE_KEY","reportQueueError","error","context","handleError","Object","assign","scope","asSafeArray","value","Array","isArray","persistEncryptedQueue","_ref","_asyncToGenerator2","default","queue","json","JSON","stringify","encrypted","encryption","encrypt","asyncStorage","setItem","op","key","_x","apply","arguments","getQueue","exports","_ref2","stored","getItem","migrated","removeItem","decrypt","parsed","parse","addToQueue","_ref3","request","now","Date","push","id","String","timestamp","_x2","removeFromQueue","_ref4","requestId","filtered","filter","item","_x3","clearQueue","_ref5","_default"],"sources":["queue.js"],"sourcesContent":["/**\r\n * Offline Queue\r\n * Stores failed/deferred requests\r\n * File: queue.js\r\n */\r\nimport { handleError } from '@errors';\r\nimport { encryption } from '@security';\r\nimport { async as asyncStorage } from '@services/storage';\r\n\r\nconst QUEUE_KEY = 'offline_queue';\r\n\r\nconst reportQueueError = (error, context) => {\r\n  handleError(error, {\r\n    scope: 'offline.queue',\r\n    ...context,\r\n  });\r\n};\r\n\r\nconst asSafeArray = (value) => {\r\n  return Array.isArray(value) ? value : [];\r\n};\r\n\r\nconst persistEncryptedQueue = async (queue) => {\r\n  try {\r\n    const json = JSON.stringify(asSafeArray(queue));\r\n    const encrypted = await encryption.encrypt(json);\r\n    return await asyncStorage.setItem(QUEUE_KEY, encrypted);\r\n  } catch (error) {\r\n    reportQueueError(error, { op: 'persistEncryptedQueue', key: QUEUE_KEY });\r\n    return false;\r\n  }\r\n};\r\n\r\n/**\r\n * Read queue from storage, decrypting if available.\r\n * Security-first: queue is never persisted unencrypted.\r\n */\r\nexport const getQueue = async () => {\r\n  const stored = await asyncStorage.getItem(QUEUE_KEY);\r\n  if (!stored) return [];\r\n\r\n  // Legacy (non-compliant) format: array stored unencrypted.\r\n  // We never keep this around â€” migrate to encrypted if possible; otherwise clear it.\r\n  if (Array.isArray(stored)) {\r\n    try {\r\n      const migrated = await persistEncryptedQueue(stored);\r\n      if (!migrated) {\r\n        await asyncStorage.removeItem(QUEUE_KEY);\r\n        return [];\r\n      }\r\n      return stored;\r\n    } catch (error) {\r\n      reportQueueError(error, { op: 'migrateLegacyQueue', key: QUEUE_KEY });\r\n      await asyncStorage.removeItem(QUEUE_KEY);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  if (typeof stored !== 'string') {\r\n    await asyncStorage.removeItem(QUEUE_KEY);\r\n    return [];\r\n  }\r\n\r\n  try {\r\n    const json = await encryption.decrypt(stored);\r\n    const parsed = JSON.parse(json);\r\n    return asSafeArray(parsed);\r\n  } catch (error) {\r\n    reportQueueError(error, { op: 'decryptQueue', key: QUEUE_KEY });\r\n    await asyncStorage.removeItem(QUEUE_KEY);\r\n    return [];\r\n  }\r\n};\r\n\r\nexport const addToQueue = async (request) => {\r\n  const queue = await getQueue();\r\n  const now = Date.now();\r\n  queue.push({\r\n    ...request,\r\n    id: String(now),\r\n    timestamp: now,\r\n  });\r\n  return await persistEncryptedQueue(queue);\r\n};\r\n\r\nexport const removeFromQueue = async (requestId) => {\r\n  const queue = await getQueue();\r\n  const filtered = queue.filter((item) => item?.id !== requestId);\r\n  return await persistEncryptedQueue(filtered);\r\n};\r\n\r\nexport const clearQueue = async () => {\r\n  // Removing the key is safe and avoids persisting even an empty queue when crypto is unavailable.\r\n  return await asyncStorage.removeItem(QUEUE_KEY);\r\n};\r\n\r\nexport default {\r\n  getQueue,\r\n  addToQueue,\r\n  removeFromQueue,\r\n  clearQueue,\r\n};\r\n\r\n"],"mappings":";;;;;;AAKA,IAAAA,OAAA,GAAAC,OAAA;AACA,IAAAC,SAAA,GAAAD,OAAA;AACA,IAAAE,QAAA,GAAAF,OAAA;AAEA,IAAMG,SAAS,GAAG,eAAe;AAEjC,IAAMC,gBAAgB,GAAG,SAAnBA,gBAAgBA,CAAIC,KAAK,EAAEC,OAAO,EAAK;EAC3C,IAAAC,mBAAW,EAACF,KAAK,EAAAG,MAAA,CAAAC,MAAA;IACfC,KAAK,EAAE;EAAe,GACnBJ,OAAO,CACX,CAAC;AACJ,CAAC;AAED,IAAMK,WAAW,GAAG,SAAdA,WAAWA,CAAIC,KAAK,EAAK;EAC7B,OAAOC,KAAK,CAACC,OAAO,CAACF,KAAK,CAAC,GAAGA,KAAK,GAAG,EAAE;AAC1C,CAAC;AAED,IAAMG,qBAAqB;EAAA,IAAAC,IAAA,OAAAC,kBAAA,CAAAC,OAAA,EAAG,WAAOC,KAAK,EAAK;IAC7C,IAAI;MACF,IAAMC,IAAI,GAAGC,IAAI,CAACC,SAAS,CAACX,WAAW,CAACQ,KAAK,CAAC,CAAC;MAC/C,IAAMI,SAAS,SAASC,oBAAU,CAACC,OAAO,CAACL,IAAI,CAAC;MAChD,aAAaM,cAAY,CAACC,OAAO,CAACxB,SAAS,EAAEoB,SAAS,CAAC;IACzD,CAAC,CAAC,OAAOlB,KAAK,EAAE;MACdD,gBAAgB,CAACC,KAAK,EAAE;QAAEuB,EAAE,EAAE,uBAAuB;QAAEC,GAAG,EAAE1B;MAAU,CAAC,CAAC;MACxE,OAAO,KAAK;IACd;EACF,CAAC;EAAA,gBATKY,qBAAqBA,CAAAe,EAAA;IAAA,OAAAd,IAAA,CAAAe,KAAA,OAAAC,SAAA;EAAA;AAAA,GAS1B;AAMM,IAAMC,QAAQ,GAAAC,OAAA,CAAAD,QAAA;EAAA,IAAAE,KAAA,OAAAlB,kBAAA,CAAAC,OAAA,EAAG,aAAY;IAClC,IAAMkB,MAAM,SAASV,cAAY,CAACW,OAAO,CAAClC,SAAS,CAAC;IACpD,IAAI,CAACiC,MAAM,EAAE,OAAO,EAAE;IAItB,IAAIvB,KAAK,CAACC,OAAO,CAACsB,MAAM,CAAC,EAAE;MACzB,IAAI;QACF,IAAME,QAAQ,SAASvB,qBAAqB,CAACqB,MAAM,CAAC;QACpD,IAAI,CAACE,QAAQ,EAAE;UACb,MAAMZ,cAAY,CAACa,UAAU,CAACpC,SAAS,CAAC;UACxC,OAAO,EAAE;QACX;QACA,OAAOiC,MAAM;MACf,CAAC,CAAC,OAAO/B,KAAK,EAAE;QACdD,gBAAgB,CAACC,KAAK,EAAE;UAAEuB,EAAE,EAAE,oBAAoB;UAAEC,GAAG,EAAE1B;QAAU,CAAC,CAAC;QACrE,MAAMuB,cAAY,CAACa,UAAU,CAACpC,SAAS,CAAC;QACxC,OAAO,EAAE;MACX;IACF;IAEA,IAAI,OAAOiC,MAAM,KAAK,QAAQ,EAAE;MAC9B,MAAMV,cAAY,CAACa,UAAU,CAACpC,SAAS,CAAC;MACxC,OAAO,EAAE;IACX;IAEA,IAAI;MACF,IAAMiB,IAAI,SAASI,oBAAU,CAACgB,OAAO,CAACJ,MAAM,CAAC;MAC7C,IAAMK,MAAM,GAAGpB,IAAI,CAACqB,KAAK,CAACtB,IAAI,CAAC;MAC/B,OAAOT,WAAW,CAAC8B,MAAM,CAAC;IAC5B,CAAC,CAAC,OAAOpC,KAAK,EAAE;MACdD,gBAAgB,CAACC,KAAK,EAAE;QAAEuB,EAAE,EAAE,cAAc;QAAEC,GAAG,EAAE1B;MAAU,CAAC,CAAC;MAC/D,MAAMuB,cAAY,CAACa,UAAU,CAACpC,SAAS,CAAC;MACxC,OAAO,EAAE;IACX;EACF,CAAC;EAAA,gBAnCY8B,QAAQA,CAAA;IAAA,OAAAE,KAAA,CAAAJ,KAAA,OAAAC,SAAA;EAAA;AAAA,GAmCpB;AAEM,IAAMW,UAAU,GAAAT,OAAA,CAAAS,UAAA;EAAA,IAAAC,KAAA,OAAA3B,kBAAA,CAAAC,OAAA,EAAG,WAAO2B,OAAO,EAAK;IAC3C,IAAM1B,KAAK,SAASc,QAAQ,CAAC,CAAC;IAC9B,IAAMa,GAAG,GAAGC,IAAI,CAACD,GAAG,CAAC,CAAC;IACtB3B,KAAK,CAAC6B,IAAI,CAAAxC,MAAA,CAAAC,MAAA,KACLoC,OAAO;MACVI,EAAE,EAAEC,MAAM,CAACJ,GAAG,CAAC;MACfK,SAAS,EAAEL;IAAG,EACf,CAAC;IACF,aAAa/B,qBAAqB,CAACI,KAAK,CAAC;EAC3C,CAAC;EAAA,gBATYwB,UAAUA,CAAAS,GAAA;IAAA,OAAAR,KAAA,CAAAb,KAAA,OAAAC,SAAA;EAAA;AAAA,GAStB;AAEM,IAAMqB,eAAe,GAAAnB,OAAA,CAAAmB,eAAA;EAAA,IAAAC,KAAA,OAAArC,kBAAA,CAAAC,OAAA,EAAG,WAAOqC,SAAS,EAAK;IAClD,IAAMpC,KAAK,SAASc,QAAQ,CAAC,CAAC;IAC9B,IAAMuB,QAAQ,GAAGrC,KAAK,CAACsC,MAAM,CAAC,UAACC,IAAI;MAAA,OAAK,CAAAA,IAAI,oBAAJA,IAAI,CAAET,EAAE,MAAKM,SAAS;IAAA,EAAC;IAC/D,aAAaxC,qBAAqB,CAACyC,QAAQ,CAAC;EAC9C,CAAC;EAAA,gBAJYH,eAAeA,CAAAM,GAAA;IAAA,OAAAL,KAAA,CAAAvB,KAAA,OAAAC,SAAA;EAAA;AAAA,GAI3B;AAEM,IAAM4B,UAAU,GAAA1B,OAAA,CAAA0B,UAAA;EAAA,IAAAC,KAAA,OAAA5C,kBAAA,CAAAC,OAAA,EAAG,aAAY;IAEpC,aAAaQ,cAAY,CAACa,UAAU,CAACpC,SAAS,CAAC;EACjD,CAAC;EAAA,gBAHYyD,UAAUA,CAAA;IAAA,OAAAC,KAAA,CAAA9B,KAAA,OAAAC,SAAA;EAAA;AAAA,GAGtB;AAAC,IAAA8B,QAAA,GAAA5B,OAAA,CAAAhB,OAAA,GAEa;EACbe,QAAQ,EAARA,QAAQ;EACRU,UAAU,EAAVA,UAAU;EACVU,eAAe,EAAfA,eAAe;EACfO,UAAU,EAAVA;AACF,CAAC","ignoreList":[]}