{"version":3,"names":["_errors","require","_api","_queue","_network","unsubscribeSync","processQueue","exports","_ref","_asyncToGenerator2","default","getIsOnline","queue","getQueue","length","item","apiClient","removeFromQueue","id","error","handleError","scope","op","apply","arguments","startSync","subscribe","snapshot","isOnline","stopSync","__unsafeResetForTests","_default"],"sources":["sync.manager.js"],"sourcesContent":["/**\r\n * Sync Manager\r\n * Orchestrates queue execution\r\n * File: sync.manager.js\r\n */\r\nimport { handleError } from '@errors';\r\nimport { apiClient } from '@services/api';\r\nimport { getQueue, removeFromQueue } from '@offline/queue';\r\nimport { getIsOnline, subscribe } from '@offline/network.listener';\r\n\r\nlet unsubscribeSync = null;\r\n\r\nexport const processQueue = async () => {\r\n  if (!getIsOnline()) return;\r\n\r\n  const queue = await getQueue();\r\n  if (queue.length === 0) return;\r\n\r\n  for (const item of queue) {\r\n    try {\r\n      await apiClient(item);\r\n      await removeFromQueue(item.id);\r\n    } catch (error) {\r\n      handleError(error, {\r\n        scope: 'offline.sync.manager',\r\n        op: 'processQueueItem',\r\n        id: item?.id,\r\n      });\r\n      // Keep in queue for retry\r\n    }\r\n  }\r\n};\r\n\r\n/**\r\n * Start syncing on network reconnect.\r\n * Idempotent: repeated calls return the same unsubscribe function.\r\n */\r\nexport const startSync = () => {\r\n  if (unsubscribeSync) return unsubscribeSync;\r\n\r\n  unsubscribeSync = subscribe((snapshot) => {\r\n    if (snapshot?.isOnline) {\r\n      // Fire-and-forget; offline sync must not block UI thread.\r\n      processQueue();\r\n    }\r\n  });\r\n\r\n  return unsubscribeSync;\r\n};\r\n\r\nexport const stopSync = () => {\r\n  if (!unsubscribeSync) return;\r\n  try {\r\n    unsubscribeSync();\r\n  } finally {\r\n    unsubscribeSync = null;\r\n  }\r\n};\r\n\r\n/**\r\n * Testing-only reset helper to avoid state leaking across unit tests.\r\n * @private\r\n */\r\nexport const __unsafeResetForTests = () => {\r\n  stopSync();\r\n};\r\n\r\nexport default {\r\n  processQueue,\r\n  startSync,\r\n  stopSync,\r\n};\r\n\r\n"],"mappings":";;;;;;AAKA,IAAAA,OAAA,GAAAC,OAAA;AACA,IAAAC,IAAA,GAAAD,OAAA;AACA,IAAAE,MAAA,GAAAF,OAAA;AACA,IAAAG,QAAA,GAAAH,OAAA;AAEA,IAAII,eAAe,GAAG,IAAI;AAEnB,IAAMC,YAAY,GAAAC,OAAA,CAAAD,YAAA;EAAA,IAAAE,IAAA,OAAAC,kBAAA,CAAAC,OAAA,EAAG,aAAY;IACtC,IAAI,CAAC,IAAAC,oBAAW,EAAC,CAAC,EAAE;IAEpB,IAAMC,KAAK,SAAS,IAAAC,eAAQ,EAAC,CAAC;IAC9B,IAAID,KAAK,CAACE,MAAM,KAAK,CAAC,EAAE;IAExB,KAAK,IAAMC,IAAI,IAAIH,KAAK,EAAE;MACxB,IAAI;QACF,MAAM,IAAAI,cAAS,EAACD,IAAI,CAAC;QACrB,MAAM,IAAAE,sBAAe,EAACF,IAAI,CAACG,EAAE,CAAC;MAChC,CAAC,CAAC,OAAOC,KAAK,EAAE;QACd,IAAAC,mBAAW,EAACD,KAAK,EAAE;UACjBE,KAAK,EAAE,sBAAsB;UAC7BC,EAAE,EAAE,kBAAkB;UACtBJ,EAAE,EAAEH,IAAI,oBAAJA,IAAI,CAAEG;QACZ,CAAC,CAAC;MAEJ;IACF;EACF,CAAC;EAAA,gBAnBYZ,YAAYA,CAAA;IAAA,OAAAE,IAAA,CAAAe,KAAA,OAAAC,SAAA;EAAA;AAAA,GAmBxB;AAMM,IAAMC,SAAS,GAAAlB,OAAA,CAAAkB,SAAA,GAAG,SAAZA,SAASA,CAAA,EAAS;EAC7B,IAAIpB,eAAe,EAAE,OAAOA,eAAe;EAE3CA,eAAe,GAAG,IAAAqB,kBAAS,EAAC,UAACC,QAAQ,EAAK;IACxC,IAAIA,QAAQ,YAARA,QAAQ,CAAEC,QAAQ,EAAE;MAEtBtB,YAAY,CAAC,CAAC;IAChB;EACF,CAAC,CAAC;EAEF,OAAOD,eAAe;AACxB,CAAC;AAEM,IAAMwB,QAAQ,GAAAtB,OAAA,CAAAsB,QAAA,GAAG,SAAXA,QAAQA,CAAA,EAAS;EAC5B,IAAI,CAACxB,eAAe,EAAE;EACtB,IAAI;IACFA,eAAe,CAAC,CAAC;EACnB,CAAC,SAAS;IACRA,eAAe,GAAG,IAAI;EACxB;AACF,CAAC;AAMM,IAAMyB,qBAAqB,GAAAvB,OAAA,CAAAuB,qBAAA,GAAG,SAAxBA,qBAAqBA,CAAA,EAAS;EACzCD,QAAQ,CAAC,CAAC;AACZ,CAAC;AAAC,IAAAE,QAAA,GAAAxB,OAAA,CAAAG,OAAA,GAEa;EACbJ,YAAY,EAAZA,YAAY;EACZmB,SAAS,EAATA,SAAS;EACTI,QAAQ,EAARA;AACF,CAAC","ignoreList":[]}