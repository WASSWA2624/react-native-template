---
alwaysApply: true
---

# Testing Strategy (Single Source of Truth)

## Purpose
Define the mandatory testing standard for **all code** (UI, hooks, utils, store, features, services).

**Rule**: No code is "done" without tests.

## Where tests live
- Tests live in `src/__tests__/`, mirroring source structure.
- File naming: `<Name>.test.js`

Examples:
- `src/platform/components/Button/` → `src/__tests__/platform/components/Button.test.js`
- `src/platform/screens/LoginScreen/` → `src/__tests__/platform/screens/LoginScreen.test.js`
- `src/hooks/useAuth.js` → `src/__tests__/hooks/useAuth.test.js`
- `src/utils/validator.js` → `src/__tests__/utils/validator.test.js`
- `src/features/auth/` → `src/__tests__/features/auth/*.test.js`
- `src/store/slices/auth.slice.js` → `src/__tests__/store/auth.test.js`

## Coverage (MANDATORY)
- **100%** coverage overall (statements, branches, functions, lines)
- **100%** coverage for critical paths: auth, payments, data validation, access control
- Branch coverage is mandatory (if/else/switch/ternary) - all code paths must be tested
- Use coverage tools (Jest `--coverage`) to verify before committing

### Achieving 100% Coverage
- **Test every branch**: Cover all if/else, switch cases, ternary operators, and early returns
- **Test error paths**: Include try/catch blocks, error handlers, and failure scenarios
- **Test edge cases**: Empty arrays, null/undefined values, boundary conditions
- **Test all variants**: Component props combinations, hook return values, utility function inputs
- **Use coverage reports**: Run `npm test -- --coverage` and address all uncovered lines
- **Exclude only when necessary**: Use `/* istanbul ignore next */` sparingly with justification
- **Refactor untestable code**: If code can't be tested, refactor to make it testable

## What must be tested (MANDATORY)

### Platform UI Components (`src/platform/components/**`)
- **All variants/states**: Default, disabled, loading, error, success, empty, selected, focused, hover (web)
- **All interactions**: Click, press, long-press, swipe, drag, keyboard navigation (web), touch gestures
- **Accessibility**: `accessibilityLabel`, `accessibilityHint`, `accessibilityRole`, `testID`, screen reader compatibility, keyboard navigation, focus management
- **Platform-specific implementations**: Test `.android.jsx`, `.ios.jsx`, `.web.jsx` separately; verify platform-specific behavior and styling
- **Props combinations**: All valid prop combinations, invalid prop handling, default props
- **Event handlers**: All callbacks (onPress, onChange, onSubmit, etc.) with various inputs
- **Error boundaries**: Component-level error handling and recovery
- **Theme integration**: Light, dark, high-contrast themes; theme switching
- **i18n**: All user-facing text uses i18n keys; locale switching

### Platform Screens (`src/platform/screens/**`)
- **Rendering**: Initial render, re-renders, conditional rendering
- **User flows**: Complete user journeys from entry to completion (login, registration, checkout, etc.)
- **Loading states**: Initial load, data fetching, async operations, skeleton screens
- **Error states**: Network errors, validation errors, server errors, error recovery flows
- **Empty states**: No data, no results, empty lists, helpful empty state messages
- **Offline states**: Network disconnection, queue status, sync status, offline actions
- **Navigation**: Route transitions, deep linking, back navigation, guard redirects
- **Form interactions**: Input validation, submission, reset, field-level errors, form-level errors
- **Data mutations**: Create, update, delete operations with success/error handling
- **Platform-specific screens**: Test `.android.jsx`, `.ios.jsx`, `.web.jsx` implementations separately

### Hooks (`src/hooks/**`, `src/platform/**/use*.js`)
- **Returned API**: All return values, state properties, functions
- **State transitions**: Initial state, state changes, state resets
- **Side effects**: useEffect dependencies, cleanup functions, async operations
- **Error handling**: Error states, error recovery, error propagation
- **Edge cases**: Null/undefined inputs, empty arrays, boundary values, invalid inputs
- **Dependencies**: Hook dependencies, memoization, re-computation triggers
- **Platform-specific hooks**: Test platform-specific hook behavior when applicable

### Utilities (`src/utils/**`)
- **Inputs/outputs**: All valid inputs, expected outputs, type validation
- **Edge cases**: Empty strings, null/undefined, boundary values, special characters, unicode
- **All branches**: Every if/else, switch case, ternary, early return
- **Error handling**: Invalid inputs, exception handling, error messages
- **Performance**: Large datasets, repeated calls, memoization effectiveness

### Features (`src/features/**`)
- **Rules (pure functions)**: All business logic rules, access control, validation rules, eligibility checks
- **Use cases (flows)**: Complete feature flows, success paths, error paths, edge cases
- **API orchestration**: Service calls (mocked), request/response handling, error handling
- **Models**: Data transformation, normalization, validation, invariants
- **Events**: Event emission, event handling, event propagation
- **Offline integration**: Queue operations, sync behavior, conflict resolution

### Store (`src/store/**`)
- **Reducers**: All action types, state transitions, immutability, edge cases
- **Selectors**: All selectors, memoization, derived state, performance
- **Thunks**: Async operations (mocked), success/error handling, loading states
- **Middleware**: All middleware behavior, action transformation, side effects
- **Persistence**: State hydration, rehydration, corruption handling

### Services (`src/services/**`)
- **API client**: Request/response handling, error handling, retry logic, timeout handling
- **Storage**: Read/write operations, encryption/decryption, error handling, platform-specific behavior
- **Analytics**: Event tracking, error handling, platform-specific implementations
- **Network**: Connectivity detection, request queuing, retry logic
- **All services**: Behavior via mocks; never hit real network/storage in unit tests

### Navigation & Routing (`src/navigation/**`, `src/app/**`)
- **Guards**: Authentication guards, role guards, subscription guards, redirect logic
- **Route groups**: Group-level layouts, group-specific guards, route organization
- **Layouts**: Root layout, group layouts, nested layouts, provider integration
- **Deep linking**: URL parsing, route matching, parameter extraction, query handling
- **Navigation flows**: Forward navigation, back navigation, tab switching, modal presentation
- **Error routes**: 404 handling, error boundaries, fallback UI

### Security (`src/security/**`)
- **Token management**: Token storage, retrieval, refresh, expiration, revocation
- **Encryption**: Encryption/decryption, key management, error handling
- **Biometric**: Biometric authentication, fallback flows, error handling
- **Permissions**: Permission requests, permission states, denial handling
- **Secure storage**: SecureStore operations, error handling, platform-specific behavior

### Offline (`src/offline/**`)
- **Network detection**: Connectivity changes, offline/online transitions, state updates
- **Queue**: Queue operations, persistence, retry logic, order preservation
- **Sync manager**: Sync orchestration, conflict resolution, partial failures, idempotency
- **Hydration**: State rehydration, queue restoration, corruption handling
- **Background sync**: Worker integration, background execution, state reporting

### Bootstrap (`src/bootstrap/**`)
- **Initialization**: Initialization order, provider setup, error handling
- **Store initialization**: Redux setup, middleware configuration, persistence
- **Theme initialization**: Theme loading, theme switching, theme persistence
- **Security initialization**: Token validation, secure storage setup
- **Offline initialization**: Queue restoration, network listener setup

### Error Handling (`src/errors/**`)
- **Error boundaries**: Error catching, error logging, fallback UI rendering
- **Error handlers**: Error normalization, error transformation, error reporting
- **Fallback UI**: Error display, recovery options, user-friendly messages

### Theme (`src/theme/**`)
- **Theme tokens**: All token values, token usage, token validation
- **Theme variants**: Light, dark, high-contrast themes, theme switching
- **Animations**: Animation definitions, animation triggers, reduced motion support
- **Breakpoints**: Responsive breakpoints, breakpoint usage, platform-specific breakpoints

### i18n (`src/i18n/**`)
- **Translation loading**: Locale loading, fallback handling, missing key handling
- **Translation usage**: Key resolution, interpolation, pluralization
- **Locale switching**: Locale changes, persistence, UI updates

## Platform-Specific Testing (MANDATORY)
- **Android implementations** (`.android.jsx`): Test Android-specific behavior, styling, interactions
- **iOS implementations** (`.ios.jsx`): Test iOS-specific behavior, styling, interactions
- **Web implementations** (`.web.jsx`): Test web-specific behavior, keyboard navigation, mouse interactions, browser compatibility
- **Platform selection**: Test `Platform.select()` logic, default platform handling
- **Platform-specific styles**: Verify correct style file imports (`.android.styles.jsx`, `.ios.styles.jsx`, `.web.styles.jsx`)

## User Interaction Testing (MANDATORY)
- **Touch interactions**: Tap, long-press, swipe, drag, pinch, multi-touch
- **Keyboard interactions** (web): Typing, tab navigation, enter/submit, escape, arrow keys, shortcuts
- **Form interactions**: Input, validation, submission, reset, field focus/blur
- **Navigation interactions**: Button clicks, link clicks, back button, tab switching, modal open/close
- **Gesture interactions**: Swipe to delete, pull to refresh, drag to reorder, pinch to zoom
- **Accessibility interactions**: Screen reader navigation, keyboard-only navigation, voice control
- **Error recovery**: Retry actions, cancel actions, alternative flows, error dismissal

## Integration Testing (MANDATORY)
- **Feature integration**: Multiple features working together, cross-feature dependencies
- **Service integration**: Service orchestration, error propagation, state synchronization
- **Navigation integration**: Complete navigation flows, guard interactions, deep linking
- **State integration**: Redux state updates, selector dependencies, middleware chains
- **Offline integration**: Offline queue + sync + UI state, network transitions, conflict resolution

## Security Testing (MANDATORY)
- **Authentication flows**: Login, logout, token refresh, session expiration, biometric auth
- **Authorization**: Role-based access, permission checks, feature gating, guard enforcement
- **Data protection**: Token storage security, encryption/decryption, secure storage operations
- **Input validation**: XSS prevention, injection prevention, input sanitization
- **Error security**: No sensitive data in errors, no tokens in logs, secure error handling

## Accessibility Testing (MANDATORY)
- **Screen readers**: All interactive elements accessible, proper labels, role announcements
- **Keyboard navigation**: Full keyboard accessibility, focus management, tab order
- **Visual accessibility**: Color contrast, focus indicators, reduced motion support
- **Touch targets**: Minimum 44x44px, adequate spacing, no overlapping targets
- **Content accessibility**: Alt text, semantic HTML, ARIA attributes (web), proper headings

## Performance Testing (MANDATORY)
- **Rendering performance**: Component render times, re-render optimization, memoization
- **Async operations**: Loading states, timeout handling, cancellation
- **Large datasets**: List rendering, pagination, virtualization
- **Memory leaks**: Cleanup functions, event listener removal, subscription cancellation

## Edge Cases & Boundary Conditions (MANDATORY)
- **Null/undefined**: All null/undefined inputs, optional props, missing data
- **Empty states**: Empty arrays, empty strings, empty objects, no data
- **Boundary values**: Min/max values, array boundaries, string length limits
- **Invalid inputs**: Wrong types, malformed data, out-of-range values
- **Concurrent operations**: Multiple simultaneous actions, race conditions, state conflicts
- **Network failures**: Timeout, connection loss, server errors, partial failures
- **Storage failures**: Storage quota exceeded, storage unavailable, corruption

## Non-negotiables (MANDATORY)
- Never call real external systems (network, storage, SDKs) in unit/integration tests.
- Mock boundaries (services, storage, time, navigation, platform) as needed.
- Prefer behavior-driven tests (testing-library style) over implementation details.
- Snapshot-only tests are not sufficient.
- All platform-specific code must be tested separately.
- All user interactions must be tested.
- All error paths must be tested.
- All loading/empty/error states must be tested.
- All accessibility features must be tested.

## Enforcement
Violations block PR approval (see `coding-conventions.mdc`).
